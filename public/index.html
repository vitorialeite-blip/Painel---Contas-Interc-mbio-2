<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel de Comunica√ß√µes ‚Äî Octa</title>
  <style>
    :root{
      --slate-50:#f8fafc; --slate-100:#f1f5f9; --slate-200:#e2e8f0; --slate-300:#cbd5e1;
      --slate-600:#475569; --slate-700:#334155; --slate-800:#1f2937; --slate-900:#0f172a;
      --rose-600:#e11d48; --rose-50:#fff1f2;
    }
    *{ box-sizing:border-box; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    html,body{ height:100%; }
    body{ margin:0; background:var(--slate-100); color:#0b1220; overflow-y:auto; }

    .page{
      max-width:1100px; margin:20px auto 140px auto; background:#fff;
      border:1px solid var(--slate-200); border-radius:14px; overflow:hidden;
      box-shadow:0 12px 34px rgba(16,24,40,.08);
    }
    .bar{ display:flex; align-items:center; justify-content:space-between; padding:12px 16px; background:#0f172a; color:#fff; }
    .content{ padding:16px; }
    .label{ font-size:13px; color:#475569; display:block; margin-bottom:4px; }
    .textarea{ margin-top:8px; width:100%; height:48vh; border:1px solid var(--slate-200); border-radius:10px; padding:12px; font-size:14px; resize:vertical; }

    /* Footer */
    .footer{
      position:fixed; left:50%; transform:translateX(-50%); bottom:0; width:1100px;
      background:rgba(15,23,42,.96); color:#fff; border-top-left-radius:12px; border-top-right-radius:12px;
      border:1px solid #00000055; z-index:9999;
    }
    .footer-inner{ display:flex; justify-content:flex-end; gap:10px; padding:12px 16px; }
    .btn{ border:0; border-radius:10px; padding:8px 12px; font-size:12px; font-weight:700; cursor:pointer; }
    .btn.white{ background:#fff; color:#111827; }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    /* Painel (menor + rolagem) */
    .panel{
      position:fixed; left:50%; transform:translateX(-50%); bottom:74px; width:980px;  /* menor */
      display:none; z-index:10000; max-height:78vh; overflow:auto;  /* rolagem interna */
    }
    .panel .wrap{ background:#fff; border:1px solid var(--slate-200); border-radius:14px; box-shadow:0 12px 34px rgba(16,24,40,.18); overflow:hidden; }
    .panel .hdr{ display:flex; align-items:center; gap:8px; padding:10px 12px; background:#0f172a; color:#fff; font-weight:800; font-size:13px; position:sticky; top:0; z-index:1;}
    .panel .body{ padding:12px; background:#fff; }

    /* Tabs compactas */
    .tabs{ display:flex; gap:6px; margin-bottom:8px; }
    .tab{ padding:6px 10px; border:1px solid var(--slate-200); border-radius:999px; background:#fff; font-weight:700; font-size:12px; cursor:pointer; }
    .tab.active{ background:#0f172a; color:#fff; border-color:#0f172a; }

    .grid{ display:grid; gap:10px; }
    .grid-2{ grid-template-columns:repeat(2,minmax(0,1fr)); }
    .grid-3{ grid-template-columns:repeat(3,minmax(0,1fr)); }
    .card{ border:1px solid var(--slate-200); border-radius:12px; padding:10px; background:#fff; color:#0b1220; }
    .input, .select{ width:100%; border:1px solid var(--slate-200); border-radius:10px; padding:8px 10px; font-size:12px; }
    .mono{ font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; font-size:12px; height:160px; }

    .muted{ color:#6b7280; font-size:12px; }
    .pill{ display:inline-flex; align-items:center; gap:6px; background:#eef2ff; color:#3730a3; border-radius:999px; padding:2px 8px; font-size:11px; font-weight:800; }
    .badge{ background:#ecfeff; border:1px solid #a5f3fc; color:#0e7490; padding:2px 6px; border-radius:999px; font-size:11px; }
    .badge-red{ background:var(--rose-50); border:1px solid var(--rose-600); color:var(--rose-600); padding:2px 6px; border-radius:999px; font-size:11px; font-weight:800; }
    .due-red{ color:var(--rose-600); font-weight:800; }
    .list{ max-height:260px; overflow:auto; display:flex; flex-direction:column; gap:8px; }
    a.link{ color:#0b5fe0; text-decoration:none; } a.link:hover{ text-decoration:underline; }
    .filters{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:10px; }
    .chip{ background:#f1f5f9; color:#334155; border:1px solid #e2e8f0; border-radius:999px; padding:4px 8px; font-size:11px; font-weight:700; }

    .req::after{ content:" *"; color:#ef4444; font-weight:800; }
    .input.error, .select.error { border-color:#ef4444 !important; box-shadow:0 0 0 3px rgba(239,68,68,.15); }
  </style>
</head>
<body>
  <div class="page">
    <div class="bar">
      <div><b>Novo Ticket</b> ‚Ä¢ Formul√°rio Oficial</div>
      <small>Simula√ß√£o</small>
    </div>
    <div class="content">
      <label class="label" for="desc">Descri√ß√£o do ticket</label>
      <textarea id="desc" class="textarea" placeholder="Digite aqui a descri√ß√£o..."></textarea>
    </div>
  </div>

  <div class="footer">
    <div class="footer-inner">
      <button class="btn white" id="btn-macros">MACROS</button>
    </div>
  </div>

  <div class="panel" id="panel">
    <div class="wrap">
      <div class="hdr">üß© Painel ‚Äî Comunica√ß√µes ‚Ä¢ Agendados ‚Ä¢ Agenda</div>
      <div class="body">
        <div class="tabs">
          <button class="tab active" data-tab="comunicacoes">Comunica√ß√µes</button>
          <button class="tab" data-tab="agendados">Agendados</button>
          <button class="tab" data-tab="agenda">Agenda</button>
        </div>

        <!-- COMUNICA√á√ïES -->
        <div id="tab-comunicacoes">
          <div class="grid grid-2">
            <label class="label">Risco
              <select class="select" id="risco">
                <option>M√©dio & Baixo</option>
                <option>Alto & Alt√≠ssimo</option>
              </select>
            </label>
            <label class="label">Etapa
              <select class="select" id="etapa"></select>
            </label>

            <label class="label req">Respons√°vel na Loja
              <input class="input" id="responsavel" placeholder="Nome da pessoa respons√°vel na loja (ou nome da loja)">
            </label>
            <label class="label req">Loja
              <input class="input" id="loja" placeholder="Nome da loja">
            </label>
            <label class="label req">CNPJ
              <input class="input" id="cnpj" placeholder="00.000.000/0000-00">
            </label>
            <label class="label req">Plataforma
              <input class="input" id="plataforma" value="VINDI" readonly>
            </label>

            <label class="label req" style="grid-column:1/-1">Descri√ß√£o de irregularidade
              <input class="input" id="produto" placeholder="Descri√ß√£o do produto">
            </label>
          </div>

          <div class="grid grid-3" style="margin-top:10px;">
            <div class="card">
              <div class="muted">Prazo sugerido</div>
              <div id="prazo" style="font-weight:700;color:#0b1220;">‚Äî</div>
            </div>
            <div class="card">
              <label class="label req" for="dataBase" style="margin:0">Data base</label>
              <input type="date" class="input" id="dataBase">
            </div>
            <div class="card">
              <div class="muted">Data limite</div>
              <div id="dataLimite" style="font-weight:700;color:#0b1220;">‚Äî</div>
            </div>
          </div>

          <div class="card" style="background:#fff; margin-top:10px;">
            <div style="font-weight:700;margin-bottom:6px;" id="macroTitulo">Comunica√ß√£o</div>
            <textarea class="input mono" id="macroText" readonly></textarea>
            <div style="display:flex; gap:8px; margin-top:8px;">
              <button class="btn" id="copiarMacro">Copiar</button>
              <button class="btn white" id="inserirMacro">Inserir na descri√ß√£o</button>
            </div>
          </div>
        </div>

        <!-- AGENDADOS -->
        <div id="tab-agendados" style="display:none;">
          <div class="grid grid-3">
            <div class="card"><span class="muted">Risco</span><div id="viewRisco" style="font-weight:700;color:#0b1220;">‚Äî</div></div>
            <div class="card"><span class="muted">Etapa</span><div id="viewEtapa" style="font-weight:700;color:#0b1220;">‚Äî</div></div>
            <div class="card"><span class="muted">Prazo</span><div id="viewPrazo" style="font-weight:700;color:#0b1220;">‚Äî</div></div>
          </div>
          <div class="card" style="margin-top:10px;background:#fff;">
            <div><b>Status:</b> <span id="viewStatus" class="muted">‚Äî</span></div>
            <div><b>Vencimento:</b> <span id="viewVenc">‚Äî</span></div>
            <div><b>Pr√≥xima a√ß√£o:</b> <span id="viewAcao">‚Äî</span></div>
          </div>
          <div class="grid grid-2" style="margin-top:10px;">
            <label class="label req">Link do ticket (Octadesk)
              <input class="input" id="linkTicket" placeholder="https://octadesk.com/...">
            </label>
            <label class="label req">Analista (selecione ou digite)
              <input class="input" id="analistaAg" list="analistasList" placeholder="Ex.: SILV√âRIA COSTA">
              <datalist id="analistasList"></datalist>
            </label>
          </div>
          <div style="margin-top:8px; display:flex; gap:10px;">
            <button class="btn" id="criarTarefa">Criar tarefa</button>
            <button class="btn white" id="limparAgendados">Limpar</button>
          </div>
        </div>

        <!-- AGENDA -->
        <div id="tab-agenda" style="display:none;">
          <div class="filters">
            <span class="muted">Data:</span>
            <input type="date" class="input" id="filtroData" style="width:170px">
            <span class="muted">Analista:</span>
            <select class="select" id="filtroAnalista" style="width:220px">
              <option value="">Todos</option>
            </select>
            <span class="muted">Comunica√ß√£o:</span>
            <select class="select" id="filtroTipo" style="width:220px">
              <option value="">Todas</option>
              <option>Comunica√ß√£o Inicial</option>
              <option>Aviso 1</option>
              <option>Aviso 2</option>
              <option>Bloqueio Efetivado</option>
              <option>Descredenciamento</option>
            </select>
            <button class="btn" id="btnExport">Exportar CSV (filtro)</button>
          </div>

          <div id="resumoChips" style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:4px;"></div>
          <div class="list" id="listaAgenda"></div>
          <div class="muted" id="totalAgenda" style="margin-top:6px;"></div>
        </div>

      </div>
    </div>
  </div>

<script>
/* ===================== REGRAS / MACROS ===================== */
const FLOWS = {
  "M√©dio & Baixo": [
    { etapa:"Comunica√ß√£o Inicial", prazoUteis:10, proximaAcao:"Enviar Aviso 1 se n√£o houver resposta", sugProxEtapa:"Aviso 1" },
    { etapa:"Aviso 1", prazoUteis:5, proximaAcao:"Enviar Aviso 2", sugProxEtapa:"Aviso 2" },
    { etapa:"Aviso 2", prazoUteis:5, proximaAcao:"Executar bloqueio", sugProxEtapa:"Bloqueio Efetivado" },
    { etapa:"Bloqueio Efetivado", prazoUteis:10, proximaAcao:"Descredenciar se n√£o houver resposta", sugProxEtapa:"Descredenciamento" },
    { etapa:"Descredenciamento", prazoUteis:30, proximaAcao:"‚Äî", sugProxEtapa:null },
  ],
  "Alto & Alt√≠ssimo": [
    { etapa:"Comunica√ß√£o Inicial", prazoUteis:10, proximaAcao:"‚Äî", sugProxEtapa:"Descredenciamento" },
    { etapa:"Descredenciamento", prazoUteis:30, proximaAcao:"‚Äî", sugProxEtapa:null },
  ],
};

const MACROS_BY_ETAPA = {
  "Comunica√ß√£o Inicial": { titulo:"Comunica√ß√£o Inicial ‚Äî Solicita√ß√£o de regulariza√ß√£o", texto:`Ol√°, {{RESPONSAVEL}}, tudo bem?

Durante uma an√°lise de rotina em nossa base, identificamos que a {{LOJA}} (CNPJ {{CNPJ}}) est√° comercializando produtos que n√£o est√£o em conformidade com as pol√≠ticas de legalidade e seguran√ßa da {{PLATAFORMA}}.

üü¶ Produto(s) identificado(s): {{PRODUTO}}

Solicitamos a remo√ß√£o imediata desses itens e o envio de um comprovante at√© {{DATA_LIMITE}}.

‚ö†Ô∏è Caso n√£o haja adequa√ß√£o no prazo, a conta poder√° ser descredenciada da plataforma.

Atenciosamente,` },
  "Aviso 1": { titulo:"Aviso 1 ‚Äî Regulariza√ß√£o pendente", texto:`Ol√°, {{RESPONSAVEL}},

Verificamos que a regulariza√ß√£o solicitada ainda n√£o foi conclu√≠da para a {{LOJA}} (CNPJ {{CNPJ}}).

üü¶ Produto(s) identificado(s): {{PRODUTO}}

Pedimos que finalize a adequa√ß√£o e nos encaminhe o comprovante at√© {{DATA_LIMITE}}.

Em caso de n√£o conformidade, avan√ßaremos para o Aviso 2 conforme nossas pol√≠ticas.

Atenciosamente,` },
  "Aviso 2": { titulo:"Aviso 2 ‚Äî Bloqueio iminente", texto:`Ol√°, {{RESPONSAVEL}},

Este √© um segundo aviso referente √† {{LOJA}} (CNPJ {{CNPJ}}). A regulariza√ß√£o permanece pendente.

üü¶ Produto(s) identificado(s): {{PRODUTO}}

Informamos que, caso n√£o recebamos o comprovante at√© {{DATA_LIMITE}}, o bloqueio da conta ser√° efetuado.

Atenciosamente,` },
  "Bloqueio Efetivado": { titulo:"Bloqueio Efetivado ‚Äî Notifica√ß√£o de bloqueio", texto:`Ol√°, {{RESPONSAVEL}},

Informamos que o bloqueio da conta da {{LOJA}} (CNPJ {{CNPJ}}) foi realizado conforme nossas pol√≠ticas, diante da aus√™ncia de regulariza√ß√£o.

Caso precise de orienta√ß√µes para reativa√ß√£o, estamos √† disposi√ß√£o.

Atenciosamente,` },
  "Descredenciamento": { titulo:"Descredenciamento ‚Äî Comunica√ß√£o final", texto:`Ol√°, {{RESPONSAVEL}},

Conforme notifica√ß√µes anteriores, identificamos que a {{LOJA}} (CNPJ {{CNPJ}}) manteve a comercializa√ß√£o de produto(s) n√£o permitidos pelas pol√≠ticas da {{PLATAFORMA}}.

Diante da aus√™ncia de adequa√ß√£o no prazo informado, comunicamos que a loja foi descredenciada da plataforma em {{DATA_DESC}}.

Permanecemos √† disposi√ß√£o para esclarecimentos formais.

Atenciosamente,` },
};

/* ===================== ESTADO / FUN√á√ïES ===================== */
const DEFAULT_ANALYSTS = [
  "SILV√âRIA COSTA",
  "IGOR ARAUJO",
  "DIEGO RIBEIRO",
  "RAFAEL CORONA"
];

const state = {
  risco:"M√©dio & Baixo",
  etapa:"Comunica√ß√£o Inicial",
  dataBase: new Date().toISOString().slice(0,10),
  responsavel:"", loja:"", cnpj:"", plataforma:"VINDI", produto:""
};

function addBusinessDays(baseDate, businessDays){
  const date = new Date(baseDate); let added=0;
  while(added<businessDays){
    date.setDate(date.getDate()+1);
    const d=date.getDay();
    if(d!==0 && d!==6){ added++; }
  }
  return date;
}
function fmt(date){ return new Intl.DateTimeFormat("pt-BR",{day:"2-digit",month:"2-digit",year:"numeric"}).format(date); }
function selectedInfo(){ return FLOWS[state.risco].find(e=>e.etapa===state.etapa) || FLOWS[state.risco][0]; }
function fillTemplate(t){
  const limite = fmt(addBusinessDays(state.dataBase,(selectedInfo().prazoUteis||0)));
  return t.replaceAll("{{RESPONSAVEL}}", state.responsavel||"<RESPONS√ÅVEL>")
    .replaceAll("{{LOJA}}", state.loja||"<LOJA>")
    .replaceAll("{{CNPJ}}", state.cnpj||"<CNPJ>")
    .replaceAll("{{PLATAFORMA}}", state.plataforma||"<PLATAFORMA>")
    .replaceAll("{{PRODUTO}}", state.produto||"<PRODUTO>")
    .replaceAll("{{DATA_LIMITE}}", limite)
    .replaceAll("{{DATA_DESC}}", fmt(new Date()));
}
function overdueInfo(due){
  const today=new Date(); today.setHours(0,0,0,0);
  const d=new Date(due); d.setHours(0,0,0,0);
  return today.getTime()>d.getTime();
}

/* ========= API HELPERS (robusto contra respostas n√£o-JSON) ========= */
async function apiFetch(url, opts = {}) {
  const res = await fetch(url, {
    headers: { 'content-type': 'application/json' },
    ...opts
  });

  const text = await res.text(); // l√™ uma vez
  let data;
  try {
    data = text ? JSON.parse(text) : null;
  } catch {
    throw new Error('Resposta inesperada da API');
  }

  if (!res.ok) {
    const msg = (data && (data.error || data.message)) || res.statusText;
    throw new Error(msg || 'Falha na API');
  }
  return data;
}
const apiGet    = (url)       => apiFetch(url);
const apiPost   = (url, body) => apiFetch(url, { method:'POST', body: JSON.stringify(body) });
const apiDelete = (url)       => apiFetch(url, { method:'DELETE' });

/* ========= UI ========= */
function updateEtapas(){
  const sel=document.getElementById("etapa");
  sel.innerHTML = FLOWS[state.risco].map(x=>`<option ${x.etapa===state.etapa?'selected':''}>${x.etapa}</option>`).join("");
}
function refreshMacro(){
  const info=selectedInfo();
  const model=MACROS_BY_ETAPA[info.etapa]||MACROS_BY_ETAPA["Comunica√ß√£o Inicial"];
  document.getElementById("macroTitulo").textContent=model.titulo;
  document.getElementById("macroText").value=fillTemplate(model.texto);
}
function refreshCommon(){
  const info=selectedInfo();
  const due=addBusinessDays(state.dataBase,info.prazoUteis||0);

  document.getElementById("prazo").textContent=(info.prazoUteis||0)+" dias √∫teis";
  document.getElementById("dataBase").value=state.dataBase;
  document.getElementById("dataLimite").textContent=fmt(due);

  document.getElementById("viewRisco").textContent=state.risco;
  document.getElementById("viewEtapa").textContent=state.etapa;
  document.getElementById("viewPrazo").textContent=info.prazoUteis+" dias √∫teis";

  const vs=document.getElementById("viewVenc");
  const st=document.getElementById("viewStatus");
  const over=overdueInfo(due);
  vs.textContent=fmt(due);
  vs.className=over?"due-red":"";
  st.innerHTML=over?'<span class="badge-red">VENCIDO</span>':'<span class="badge">No prazo</span>';

  document.getElementById("viewAcao").textContent=info.proximaAcao;
}
function refreshAll(){ refreshCommon(); refreshMacro(); updateAgendaList(true); }

/* ===================== VALIDA√á√ïES ===================== */
function clearErrors(ids){ ids.forEach(id => document.getElementById(id)?.classList.remove('error')); }
function markError(id){ const el=document.getElementById(id); if(el) el.classList.add('error'); }
function isCNPJ(val){ const digits=(val||"").replace(/\D/g,''); return /^\d{14}$/.test(digits); }

function validateComunicacao(){
  const req = [
    {id:'responsavel', label:'Respons√°vel na Loja', test:v=>v.trim().length>1},
    {id:'loja',        label:'Loja',                 test:v=>v.trim().length>1},
    {id:'cnpj',        label:'CNPJ',                 test:isCNPJ},
    {id:'plataforma',  label:'Plataforma',           test:v=>v.trim().length>0},
    {id:'produto',     label:'Produto irregular',    test:v=>v.trim().length>1},
    {id:'dataBase',    label:'Data base',            test:v=>!!v}
  ];
  clearErrors(req.map(r=>r.id));
  const fails=[];
  req.forEach(r=>{ const v=document.getElementById(r.id)?.value ?? ""; if(!r.test(v)) { markError(r.id); fails.push(r.label);} });
  if(fails.length){ alert("Preencha os campos obrigat√≥rios:\n- "+fails.join("\n- ")); return false; }
  return true;
}

/* ===================== HANDLERS UI ===================== */
document.getElementById("btn-macros").addEventListener("click",(e)=>{
  e.stopPropagation();
  const p=document.getElementById("panel");
  p.style.display=(p.style.display==="block")?"none":"block";
});
document.addEventListener("click",(e)=>{
  const p=document.getElementById("panel"); const b=document.getElementById("btn-macros");
  if(!(p.contains(e.target)||b.contains(e.target))) p.style.display="none";
});
document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click",(e)=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    e.currentTarget.classList.add("active");
    const key=e.currentTarget.dataset.tab;
    document.getElementById("tab-comunicacoes").style.display=key==="comunicacoes"?"block":"none";
    document.getElementById("tab-agendados").style.display=key==="agendados"?"block":"none";
    document.getElementById("tab-agenda").style.display=key==="agenda"?"block":"none";
  });
});
document.getElementById("risco").addEventListener("change",(e)=>{
  state.risco=e.target.value; state.etapa=FLOWS[state.risco][0].etapa; updateEtapas(); refreshAll();
});
document.getElementById("etapa").addEventListener("change",(e)=>{ state.etapa=e.target.value; refreshAll(); });
["responsavel","loja","cnpj","plataforma","produto"].forEach(id=>{
  document.getElementById(id).addEventListener("input",(e)=>{ state[id]=e.target.value; refreshAll(); });
});
document.getElementById("dataBase").addEventListener("change",(e)=>{ state.dataBase=e.target.value; refreshAll(); });

document.getElementById("copiarMacro").addEventListener("click",()=>{
  navigator.clipboard?.writeText(document.getElementById("macroText").value);
  alert("Comunica√ß√£o copiada!");
});

document.getElementById("limparAgendados").addEventListener("click",()=>{
  document.getElementById("linkTicket").value = "";
  document.getElementById("analistaAg").value = "";
});

/* Criar tarefa ‚Äì via API (POST /api/tickets) */
document.getElementById("criarTarefa").addEventListener("click", async () => {
  try {
    const ticket   = (document.getElementById("linkTicket").value || "").trim();
    const analista = (document.getElementById("analistaAg").value || "").trim();
    document.getElementById("linkTicket").classList.remove("error");
    document.getElementById("analistaAg").classList.remove("error");
    const falta = [];
    if (!ticket)   { falta.push("Link do ticket"); document.getElementById("linkTicket").classList.add("error"); }
    if (!analista) { falta.push("Analista");       document.getElementById("analistaAg").classList.add("error"); }
    if (falta.length) { alert("Preencha os campos obrigat√≥rios:\n- " + falta.join("\n- ")); return; }

    const info   = selectedInfo();
    const dueDate = addBusinessDays(state.dataBase, info.prazoUteis || 0).toISOString().slice(0,10); // sincroniza com vencimento
    const payload = {
      cliente   : state.loja || "<LOJA>",
      etapa     : info.etapa,
      risco     : state.risco,
      due       : dueDate,         // YYYY-MM-DD (vencimento sincronizado)
      analista  : analista,
      obs       : info.proximaAcao,
      ticket_url: ticket
    };

    await apiPost("/api/tickets", payload);

    // Limpa campos
    document.getElementById("linkTicket").value = "";
    document.getElementById("analistaAg").value = "";

    // Vai para AGENDA e sincroniza data do filtro com o vencimento
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    document.querySelector('[data-tab="agenda"]').classList.add("active");
    document.getElementById("tab-comunicacoes").style.display="none";
    document.getElementById("tab-agendados").style.display="none";
    document.getElementById("tab-agenda").style.display="block";
    document.getElementById("filtroData").value = dueDate;

    await updateAgendaList(true);
    alert("Tarefa criada com sucesso!");
  } catch (err) {
    console.error(err);
    alert("N√£o foi poss√≠vel criar a tarefa. Veja logs.\n" + err.message);
  }
});

/* ===================== AGENDA (GET + DELETE) ===================== */
async function updateAgendaList(forceFromServer=false){
  const filtro = document.getElementById("filtroData").value || new Date().toISOString().slice(0,10);
  const etapa  = document.getElementById("filtroTipo").value || "";
  const anal   = document.getElementById("filtroAnalista").value || "";

  const ui     = document.getElementById("listaAgenda");
  const chips  = document.getElementById("resumoChips");
  ui.innerHTML = `<div class="muted">Carregando‚Ä¶</div>`;

  try {
    const q = new URLSearchParams();
    q.set("date", filtro);
    if (etapa) q.set("etapa", etapa);
    if (anal)  q.set("analista", anal);
    const items = await apiGet(`/api/tickets?${q.toString()}`);
    const data  = Array.isArray(items) ? items : [];      // tolerante

    // popular filtro de analistas
    const namesSrv = Array.from(new Set(data.map(t => t.analista).filter(Boolean)));
    const names = Array.from(new Set([...DEFAULT_ANALYSTS, ...namesSrv])).sort();
    const selAnal = document.getElementById("filtroAnalista");
    const cur = selAnal.value;
    selAnal.innerHTML = `<option value="">Todos</option>` + names.map(n => `<option ${cur===n?'selected':''}>${n}</option>`).join("");

    // datalist do formul√°rio de cria√ß√£o
    const dl = document.getElementById("analistasList");
    dl.innerHTML = names.map(n => `<option value="${n}"></option>`).join("");

    const byEtapa = {};
    data.forEach(t => { byEtapa[t.etapa] = (byEtapa[t.etapa]||0)+1; });
    chips.innerHTML = Object.keys(byEtapa).length
      ? Object.entries(byEtapa).map(([k,v]) => `<span class="chip">${k}: ${v}</span>`).join("")
      : `<span class="muted">Sem comunica√ß√µes neste dia.</span>`;

    if (!data.length){
      ui.innerHTML = `<div class="muted">Nenhuma tarefa para esta data.</div>`;
    } else {
      ui.innerHTML = "";
      data.forEach(t => {
        const over = overdueInfo(t.due);
        const venc = fmt(new Date(t.due));
        const card = document.createElement("div");
        card.className = "card";
        card.style.background = "#fff";
        card.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;">
            <div><b>${t.cliente}</b> <span class="pill">${t.risco}</span></div>
            <div style="display:flex; gap:8px; align-items:center;">
              <span class="${over?'badge-red':'badge'}">${over?'VENCIDO':(t.analista||"‚Äî")}</span>
              <button class="btn" data-del="${t.id}" title="Excluir">üóëÔ∏è</button>
            </div>
          </div>
          <div class="muted">Etapa: ${t.etapa} ‚Ä¢ Venc.: <b class="${over?'due-red':''}">${venc}</b></div>
          <div class="muted">Obs: ${t.obs||"‚Äî"}</div>
          ${t.ticket_url ? `<div><a class="link" href="${t.ticket_url}" target="_blank" rel="noopener">üîó Abrir ticket</a></div>` : ""}
        `;
        card.querySelector('[data-del]').addEventListener('click', async () => {
          if (!confirm("Excluir este ticket?")) return;
          try {
            await apiDelete(`/api/tickets/${t.id}`);
            await updateAgendaList(true);
          } catch(e) {
            alert("Erro ao excluir: " + e.message);
          }
        });
        ui.appendChild(card);
      });
    }
    document.getElementById("totalAgenda").textContent = "Total (servidor): " + data.length;
  } catch (err) {
    console.error(err);
    ui.innerHTML = `<div class="muted">Falha ao carregar: ${err.message}</div>`;
    alert("Erro ao carregar agenda do servidor.\n" + err.message);
  }
}

function exportCsv(){
  const filtro=document.getElementById("filtroData").value||new Date().toISOString().slice(0,10);
  const etapa=document.getElementById("filtroTipo").value;
  const anal=document.getElementById("filtroAnalista").value;
  const q = new URLSearchParams();
  q.set("date", filtro);
  if (etapa) q.set("etapa", etapa);
  if (anal)  q.set("analista", anal);

  apiGet(`/api/tickets?${q.toString()}`).then(items=>{
    const data = Array.isArray(items) ? items : [];
    const headers=["ID","Cliente","Etapa","Risco","Vencimento","Analista","Pr√≥xima a√ß√£o","Ticket","Status"];
    const rows=data.map(t=>[
      t.id, t.cliente, t.etapa, t.risco, fmt(new Date(t.due)),
      t.analista||"", t.obs||"", t.ticket_url||"", (overdueInfo(t.due)?"VENCIDO":"No prazo")
    ]);
    const csv=[headers,...rows].map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(",")).join("\n");
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"}); const url=URL.createObjectURL(blob);
    const a=document.createElement("a"); a.href=url; a.download=`agenda_${filtro}${etapa?("_"+etapa.replaceAll(" ","_")):""}${anal?("_"+anal.replaceAll(" ","_")):""}.csv`;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }).catch(err=>{
    alert("Falha ao exportar: "+err.message);
  });
}

/* ===================== BOOT ===================== */
["filtroData","filtroAnalista","filtroTipo"].forEach(id=>{
  document.getElementById(id).addEventListener("change",()=>updateAgendaList(true));
});
document.getElementById("btnExport").addEventListener("click",exportCsv);

(function boot(){
  // analistas default no datalist e no filtro
  const dl = document.getElementById("analistasList");
  dl.innerHTML = DEFAULT_ANALYSTS.map(n => `<option value="${n}"></option>`).join("");
  const selAnal = document.getElementById("filtroAnalista");
  selAnal.innerHTML = `<option value="">Todos</option>` + DEFAULT_ANALYSTS.map(n => `<option>${n}</option>`).join("");

  document.getElementById("dataBase").value=state.dataBase;
  document.getElementById("filtroData").value=new Date().toISOString().slice(0,10);
  updateEtapas(); refreshAll();
})();
</script>
</body>
</html>
